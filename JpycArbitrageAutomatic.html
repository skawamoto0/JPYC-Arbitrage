<!DOCTYPE html>
<html lang="en">
<head>
<title>JPYC Arbitrage</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.boxinline{
	display: inline-block;
	padding: 0.5em;
	margin: 0.25em;
	border-radius: 0.5em;
}
.boxoneline{
	display: block;
	min-height: 1em;
	padding: 0.5em;
	margin: 0.25em;
	border-radius: 0.5em;
}
.textmain{
	color: #000000;
	background-color: #ffffff;
	text-align: left;
	font-size: 1em;
}
.texttitle1{
	color: #000000;
	background-color: #40a0ff;
	text-align: center;
	font-size: 1.5em;
	font-weight: bold;
}
.texttitle2{
	color: #000000;
	background-color: #c0e0ff;
	text-align: center;
	font-size: 1.5em;
}
.textouter{
	color: #000000;
	background-color: #ffffff;
	font-size: 1em;
}
.textfloat{
	color: #000000;
	background-color: #e0ffff;
	text-align: left;
	font-size: 1em;
}
.textpopup{
	color: #000000;
	background-color: #ffffe0;
	text-align: left;
	font-size: 1rem;
}
.textinput{
	color: #000000;
	background-color: #ffffff;
	font-size: 0.75em;
}
.textbutton1{
	color: #000000;
	background-color: #80ff80;
	font-size: 0.75em;
}
.textbutton2{
	color: #000000;
	background-color: #ff8080;
	font-size: 0.75em;
}
.textoutput{
	color: #000000;
	background-color: #e0e0e0;
	font-size: 1em;
}
.imageinline{
	height: 1em;
	margin: 0em;
	border: 0em;
	vertical-align: middle;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script type="text/javascript">
function JpycArbitrage(){
	let t = this;
	t.web3 = new Web3("https://polygon-rpc.com/");
	t.ContractAddress = "";
	t.PrivateKey = "";
	t.Amount = t.web3.utils.toBN(0);
	t.Threshold = t.web3.utils.toBN(0);
	t.bn10e18 = t.web3.utils.toBN(10).pow(t.web3.utils.toBN(18));
	t.Timer = null;
	t.GetGasPrice = function(){
		return new Promise(function(a, b){
			let x = new XMLHttpRequest();
			x.onload = function(){
				if(x.status == 200){
					a(Math.min(parseInt(JSON.parse(x.response).standard) + 1, 500) + "000000000");
				}else{
					b(x.status);
				}
			};
			x.onerror = function(){
				b(null);
			}
			x.open("GET", "https://gasstation-mainnet.matic.network/");
			x.send();
		});
	};
	t.BalanceOfJpyc = function(){
		let t = this;
		return new Promise(function(a, b){
			let abi = [
				{
					inputs : [
						{
							name : "",
							type : "address"
						}
					],
					name : "balanceOf",
					outputs : [
						{
							name : "",
							type : "uint256"
						}
					],
					type : "function"
				}
			];
			let c = new t.web3.eth.Contract(abi, "0x6AE7Dfc73E0dDE2aa99ac063DcF7e8A63265108c");
			c.methods.balanceOf(t.web3.eth.accounts.privateKeyToAccount(t.PrivateKey).address).call().then(function(x){
				a(x);
			});
		});
	};
	t.AllowanceJpyc = function(){
		let t = this;
		return new Promise(function(a, b){
			let abi = [
				{
					inputs : [
						{
							name : "",
							type : "address"
						},
						{
							name : "",
							type : "address"
						}
					],
					name : "allowance",
					outputs : [
						{
							name : "",
							type : "uint256"
						}
					],
					type : "function"
				}
			];
			let c = new t.web3.eth.Contract(abi, "0x6AE7Dfc73E0dDE2aa99ac063DcF7e8A63265108c");
			c.methods.allowance(t.web3.eth.accounts.privateKeyToAccount(t.PrivateKey).address, t.ContractAddress).call().then(function(x){
				a(x);
			});
		});
	};
	t.ApproveJpyc = function(){
		let t = this;
		return new Promise(function(a, b){
			let abi = [
				{
					inputs : [
						{
							name : "",
							type : "address"
						},
						{
							name : "",
							type : "uint256"
						}
					],
					name : "approve",
					outputs : [
						{
							name : "",
							type : "bool"
						}
					],
					type : "function"
				}
			];
			let c = new t.web3.eth.Contract(abi, "0x6AE7Dfc73E0dDE2aa99ac063DcF7e8A63265108c");
			t.GetGasPrice().then(function(x){
				t.web3.eth.accounts.signTransaction({to : "0x6AE7Dfc73E0dDE2aa99ac063DcF7e8A63265108c", data : c.methods.approve(t.ContractAddress, t.web3.utils.toBN("0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff")).encodeABI(), gasPrice : x, gas : 100000}, t.PrivateKey).then(function(x){
					t.web3.eth.sendSignedTransaction(x.rawTransaction).then(function(x){
						a(x);
					});
				});
			});
		});
	};
	t.CheckArbitrage = function(){
		let t = this;
		return new Promise(function(a, b){
			let abi = [
				{
					inputs : [
						{
							name : "amount",
							type : "uint256"
						}
					],
					name : "checkArbitrage",
					outputs : [
						{
							name : "",
							type : "uint256"
						},
						{
							name : "",
							type : "uint256"
						}
					],
					type : "function"
				}
			];
			let c = new t.web3.eth.Contract(abi, t.ContractAddress);
			c.methods.checkArbitrage(t.Amount).call().then(function(x){
				a(x);
			});
		});
	};
	t.Arbitrage = function(Route){
		let t = this;
		return new Promise(function(a, b){
			let abi = [
				{
					inputs : [
						{
							name : "amount",
							type : "uint256"
						},
						{
							name : "minimum",
							type : "uint256"
						},
						{
							name : "route",
							type : "uint256"
						},
						{
							name : "loop",
							type : "uint256"
						}
					],
					name : "arbitrage",
					outputs : [],
					type : "function"
				}
			];
			let c = new t.web3.eth.Contract(abi, t.ContractAddress);
			t.GetGasPrice().then(function(x){
				t.web3.eth.accounts.signTransaction({to : t.ContractAddress, data : c.methods.arbitrage(t.Amount, t.Amount, Route, 5).encodeABI(), gasPrice : x, gas : 3000000}, t.PrivateKey).then(function(x){
					t.web3.eth.sendSignedTransaction(x.rawTransaction).then(function(x){
						a(x);
					});
				});
			});
		});
	};
	t.EncryptPrivateKey = function(Password, IV, PrivateKey){
		let t = this;
		return new Promise(function(a, b){
			crypto.subtle.importKey("jwk", {kty : "oct", k : Password + "0000000000000000000000000000000000000000000".slice(Password.length), alg : "A256GCM", ext : true}, {name : "AES-GCM"}, false, ["encrypt", "decrypt"]).then(function(x){
				crypto.subtle.encrypt({name : "AES-GCM", iv : IV}, x, new TextEncoder().encode(PrivateKey)).then(function(x){
					a(new Uint8Array(x));
				});
			});
		});
	};
	t.DecryptPrivateKey = function(Password, IV, PrivateKey){
		let t = this;
		return new Promise(function(a, b){
			crypto.subtle.importKey("jwk", {kty : "oct", k : Password + "0000000000000000000000000000000000000000000".slice(Password.length), alg : "A256GCM", ext : true}, {name : "AES-GCM"}, false, ["encrypt", "decrypt"]).then(function(x){
				crypto.subtle.decrypt({name : "AES-GCM", iv : IV}, x, PrivateKey).then(function(x){
					a(new TextDecoder().decode(x));
				});
			});
		});
	};
	t.Approve = function(){
		let t = this;
		t.AllowanceJpyc().then(function(x){
			if(t.web3.utils.toBN(x).lt(t.web3.utils.toBN("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"))){
				t.Log("Approve the contract");
				t.ApproveJpyc().then(function(x){
					t.Log("Transaction hash : " + x.transactionHash);
				});
			}else{
				t.Log("The contract is already approved");
			}
		});
	};
	t.Update = function(){
		let t = this;
		localStorage.setItem("JpycArbitrage.private", document.getElementById("private").value);
		localStorage.setItem("JpycArbitrage.iv", document.getElementById("iv").value);
		localStorage.setItem("JpycArbitrage.amount", document.getElementById("amount").value);
		localStorage.setItem("JpycArbitrage.threshold", document.getElementById("threshold").value);
		t.ContractAddress = document.getElementById("contract").value;
		t.Amount = t.web3.utils.toBN(document.getElementById("amount").value).mul(t.bn10e18);
		t.Threshold = t.web3.utils.toBN(document.getElementById("threshold").value).mul(t.bn10e18);
		document.getElementById("auth").innerText = "Password is incorrect";
		t.DecryptPrivateKey(document.getElementById("password").value, Function("return new Uint8Array(" + document.getElementById("iv").value + ");")(), Function("return new Uint8Array(" + document.getElementById("private").value + ");")()).then(function(x){
			document.getElementById("auth").innerText = "Password is authenticated";
			if(x != t.PrivateKey){
				t.PrivateKey = x;
				t.BalanceOfJpyc().then(function(x){
					document.getElementById("balance").innerText = "Balance " + (parseInt(x) / (10 ** 18)) + " JPYC";
				});
			}
		});
	};
	t.UpdatePrivateKey = function(){
		let t = this;
		t.EncryptPrivateKey(document.getElementById("password").value, Function("return new Uint8Array(" + document.getElementById("iv").value + ");")(), document.getElementById("newprivate").value).then(function(x){
			document.getElementById("private").value = "[" + x.toString() + "]";
			document.getElementById("newprivate").value = "";
			t.Update();
		});
	}
	t.Log = function(x){
		document.getElementById("log").innerText += new Date().toISOString() + " " + x + "\n";
	};
	t.Loop = function(){
		let t = this;
		try{
			t.Update();
			t.CheckArbitrage().then(function(x){
				document.getElementById("quote").innerText = "Profit will be " + ((parseInt(x[0]) - parseInt(t.Amount)) / (10 ** 18)) + " JPYC with the route " + x[1];
				if(t.web3.utils.toBN(t.Threshold).gt(t.web3.utils.toBN(0)) && t.web3.utils.toBN(x[0]).gte(t.Amount) && t.web3.utils.toBN(x[0]).sub(t.Amount).gte(t.Threshold)){
					t.Log("Profit will be " + ((parseInt(x[0]) - parseInt(t.Amount)) / (10 ** 18)) + " JPYC with the route " + x[1]);
					t.Arbitrage(x[1]).then(function(x){
						t.Log("Transaction hash : " + x.transactionHash);
						t.BalanceOfJpyc().then(function(x){
							document.getElementById("balance").innerText = "Balance " + (parseInt(x) / (10 ** 18)) + " JPYC";
						});
					});
				}
			});
		}catch(e){
		}
		t.Timer = setTimeout(function(){
			t.Loop();
		}, 60000);
	};
	t.StartLoop = function(){
		let t = this;
		try{
			document.getElementById("private").value = localStorage.getItem("JpycArbitrage.private") || "";
			document.getElementById("iv").value = localStorage.getItem("JpycArbitrage.iv") || "[0,0,0,0,0,0,0,0,0,0,0,0]";
			document.getElementById("amount").value = localStorage.getItem("JpycArbitrage.amount") || "10000";
			document.getElementById("threshold").value = localStorage.getItem("JpycArbitrage.threshold") || "100";
		}catch(e){
		}
		t.Loop();
	};
	t.StopLoop = function(){
		let t = this;
		clearTimeout(t.Timer);
	};
}
function InitializePopup(Name){
	Array.prototype.forEach.call(document.getElementsByName(Name), function(e){
		new (function(x){
			let t = this;
			t.Popup = x;
			t.Popup.style.position = "fixed";
			t.Popup.style.zIndex = "1";
			t.Popup.style.display = "none";
			t.Popup.parentNode.addEventListener("mousemove", function(e){
				t.Popup.style.left = (e.clientX + 1) + "px";
				t.Popup.style.top = (e.clientY + 1) + "px";
			});
			t.Popup.parentNode.addEventListener("mouseenter", function(e){
				t.Popup.style.display = "block";
			});
			t.Popup.parentNode.addEventListener("mouseleave", function(e){
				t.Popup.style.display = "none";
			});
		})(e);
	});
}
function InitializeTokenImage(Name){
	let ImageUrl = {
		"0x6ae7dfc73e0dde2aa99ac063dcf7e8a63265108c" : "https://assets.coingecko.com/coins/images/17277/small/WoZ8rruL_400x400.png",
		"0x2791bca1f2de4661ed88a30c99a7a9449aa84174" : "https://assets.coingecko.com/coins/images/6319/small/USD_Coin_icon.png",
		"0x8343091f2499fd4b6174a46d067a920a3b851ff9" : "https://assets.coingecko.com/coins/images/24327/small/jJPY.png"
	};
	Array.prototype.forEach.call(document.getElementsByName(Name), function(e){
		e.src = ImageUrl[e.id.toLowerCase()];
	});
}
var JA = new JpycArbitrage();
</script>
</head>
<body onload="JA.StartLoop();InitializePopup('popup');InitializeTokenImage('token');">
<div class="boxoneline textouter" style="margin: auto; width: 65em;">
<div class="boxoneline texttitle1"><img name="token" id="0x6ae7dfc73e0dde2aa99ac063dcf7e8a63265108c" class="imageinline">➡<img name="token" id="0x2791bca1f2de4661ed88a30c99a7a9449aa84174" class="imageinline">➡<img name="token" id="0x8343091f2499fd4b6174a46d067a920a3b851ff9" class="imageinline">➡<img name="token" id="0x6ae7dfc73e0dde2aa99ac063dcf7e8a63265108c" class="imageinline"> JPYC Arbitrage <img name="token" id="0x6ae7dfc73e0dde2aa99ac063dcf7e8a63265108c" class="imageinline">➡<img name="token" id="0x8343091f2499fd4b6174a46d067a920a3b851ff9" class="imageinline">➡<img name="token" id="0x2791bca1f2de4661ed88a30c99a7a9449aa84174" class="imageinline">➡<img name="token" id="0x6ae7dfc73e0dde2aa99ac063dcf7e8a63265108c" class="imageinline"></div>
<div class="boxinline textfloat" style="min-width: 20em; vertical-align: top;">
<div class="boxoneline texttitle2">User authentication</div>
<div class="boxoneline">
<span>Encrypted private key<div name="popup" class="boxinline textpopup">The private key is encrypted with the password and the seed to prevent theft.</div></span><br>
<input type="text" id="private" class="boxinline textinput" onchange="JA.Update();"><br>
<span>Initialization vector<div name="popup" class="boxinline textpopup">This is a seed for encryption.</div></span><br>
<input type="text" id="iv" class="boxinline textinput" onchange="JA.Update();"><br>
<span>Password<div name="popup" class="boxinline textpopup">This is used for encryption of the private key.<br>This can be empty but it is not recommended.<br>Only uppercase and lowercase letters, digits and hyphen are accepted.<br>The length should be less than 43 characters.</div></span><br>
<input type="password" id="password" class="boxinline textinput" onchange="JA.Update();"><br>
</div>
</div>
<div class="boxinline textfloat" style="min-width: 20em; vertical-align: top;">
<div class="boxoneline texttitle2">User data settings</div>
<div class="boxoneline">
<span>Your private key<div name="popup" class="boxinline textpopup">This should be tied to an wallet address that has JPYC <img name="token" id="0x6ae7dfc73e0dde2aa99ac063dcf7e8a63265108c" class="imageinline"> tokens.<br>The key should start with 0x and be 64 characters length hexadecimal.<br>If you set a password and save this, you should enter the password every time when the page is reloaded.</div></span><br>
<input type="text" id="newprivate" value="0x" class="boxinline textinput"><br>
<form onsubmit="JA.UpdatePrivateKey();return false;">
<input type="submit" value="Encrypt and save the private key" class="boxinline textbutton1">
</form>
</div>
</div>
<div class="boxinline textfloat" style="min-width: 20em; vertical-align: top;">
<div class="boxoneline texttitle2">Contract settings</div>
<div class="boxoneline">
<span>Contract address<div name="popup" class="boxinline textpopup">This is the address of the arbitrage contract.<br>Normally you do not have to change this.</div></span><br>
<input type="text" id="contract" value="0x6a312D34b5b2566eceb43AaD1840cD78e1bbf18e" class="boxinline textinput"><br>
<span>Amount<div name="popup" class="boxinline textpopup">This is how many tokens will be used for a transaction.<br>Only integer values are accepted.</div></span><br>
<input type="text" id="amount" class="boxinline textinput"><br>
<span>Threshold<div name="popup" class="boxinline textpopup">Transactions will be issued if the profit is more than or equal to this.<br>Only integer values are accepted.</div></span><br>
<input type="text" id="threshold" class="boxinline textinput"><br>
<form onsubmit="JA.Approve();return false;">
<input type="submit" value="Approve the token" class="boxinline textbutton1">
</form>
</div>
</div>
<div class="boxoneline textfloat">
<div class="boxoneline texttitle2">Status</div>
<div id="auth" class="boxoneline textoutput"></div>
<div id="balance" class="boxoneline textoutput"></div>
<div id="quote" class="boxoneline textoutput"></div>
</div>
<div class="boxoneline textfloat">
<div class="boxoneline texttitle2">Log</div>
<div id="log" class="boxoneline textoutput"></div>
</div>
</div>
</body>
</html>
